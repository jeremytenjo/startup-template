import{onCall as ee,onRequest as he}from"firebase-functions/v2/https";function o(e){var a;let t=[],r={cause:{props:e,missingProps:t}};if(!e.props&&!e.condition)throw new Error("props are undefined",r);if(e.props){if(e.requiredProps&&((a=e.requiredProps)!=null&&a.length)&&e.requiredProps.forEach(s=>{var c;let i=String(s);if(((c=e.props)==null?void 0:c[i])===void 0)throw new Error(`Missing required prop: ${i}`,r)}),t.length)throw new Error(`Missing props: ${t.join(",")}`,r)}else if(!Boolean(e.condition))throw new Error("condition failed",r)}import O from"firebase-functions/logger";import{HttpsError as re}from"firebase-functions/v2/https";import{PostHog as te}from"posthog-node";var b={id:"phc_5De3zkqxgnVuGlleXVVtcN5oBC0VW8cLvY7rraPqjWQ",initContig:{api_host:"https://app.posthog.com",autocapture:!1,capture_pageleave:!1,capture_pageview:!1,disable_session_recording:!0}};async function u(e){var t;if(o({props:e,requiredProps:["eventName","data"]}),((t=process==null?void 0:process.env)==null?void 0:t.NODE_ENV)==="production"&&b.id){let r=new te(b.id);r.capture({distinctId:"nodePostHog",event:e.eventName,properties:{...e.data,metadata:e.data}}),await r.shutdownAsync()}}async function g(e){o({props:e,requiredProps:["description","fnName"]}),u({eventName:"error",data:{description:String(e.description),functionName:e.fnName,uid:e.uid||"",metadata:e==null?void 0:e.metadata}})}function p(e){var a;o({props:e,requiredProps:["description","fnName"]});let t=((a=e.metadata)==null?void 0:a.publicErrorMessage)||"Error. Please try again later.",r={fnName:String(e.fnName),description:String(e.description),metadata:{...e.metadata,publicErrorMessage:t},uid:e.uid,publicErrorMessage:t};if(g(r),e.throwHttpsError)throw O.error(r.fnName+` - ${r.description}`,r),new re("failed-precondition",JSON.stringify(r));if(O.error(r.fnName+` - ${r.description}`,r),e.throwError)throw new Error(`${r.fnName} - ${r.description}`)}import V from"firebase-functions/logger";import H from"firebase-admin";H.initializeApp();function d(){return{firebaseAdmin:H}}var m="users";function C(e){o({props:e,requiredProps:["uid"]}),u({eventName:"user_deactivated_account",data:{...e}})}var l="routes/deactivateAccount";async function x(e){var s,i;if(V.info(`START: ${l}`,{props:e}),o({props:e,requiredProps:["payload"]}),o({props:e.payload,requiredProps:["uid"]}),((s=e.payload)==null?void 0:s.uid)!==((i=e.authUser)==null?void 0:i.uid))throw new Error("User Id does not match Auth User Id");let{firebaseAdmin:t}=d();await t.auth().deleteUser(e.authUser.uid);let r=await t.firestore().collection(m).where("id","==",e.authUser.uid).limit(1).get().then(c=>{if(c.empty)throw new Error("User Doc not found");return c.docs[0].data()});await t.firestore().collection(m).doc(r.id).delete(),C({uid:e.authUser.uid});let a={data:[{id:r.id,success:!0}]};return V.info(`END: ${l}`,{response:a}),a}import K from"firebase-functions/logger";import ae from"stripe";function n(){let e=process.env.NODE_ENV==="production"?process.env.STRIPE_SECRET_KEY_PRODUCTION:process.env.STRIPE_SECRET_KEY_DEVELOPMENT;if(!e)throw new Error("Unauthorized access to Stripe API");return{stripe:new ae(e,{apiVersion:"2022-11-15"})}}var j=()=>process.env.NODE_ENV==="production",ne={siteInfo:{name:"Startup Template",description:"description",domain:"https://www.domain.com",previewDomain:"https://www.previewDomain.com"},socialLinks:{discord:{link:"https://discord.gg/startup"},mailto:{link:"mailto:info@socialseed.com"}},nextjs:{port:3001},firebase:{enabled:!0},devtools:{storybook:{port:6006},playwright:{testIdAttribute:"data-id"}},featureFlags:{email:{enabled:j()},credits:{developer:{enabled:!0}}},getIsPreviewEnv:()=>process.env.NEXT_PUBLIC_ENV==="preview",getIsProductionEnv:j},M=ne;function E(e){o({props:e,requiredProps:["source","user"]}),u({eventName:"seller_added_bank_account",data:{source:e.source,metadata:{...e}}})}var f="routes/createConnectedAccount";async function w(e){var c;if(K.info(`START: ${f}`,{props:e}),o({props:e,requiredProps:["payload"]}),o({props:e.payload,requiredProps:["refreshUrl","returnUrl","userToCreateAccount"]}),!((c=e.authUser)!=null&&c.uid))throw new Error("props.authUser?.uid is undefined",{cause:{}});let{stripe:t}=n(),r=await t.accounts.create({type:"express",business_type:"individual",business_profile:{url:`${M.siteInfo.domain}/user/${e.payload.userToCreateAccount.displayName}`},settings:{payouts:{schedule:{interval:"daily",delay_days:2}}}}),a=await t.accountLinks.create({type:"account_onboarding",account:r.id,refresh_url:e.payload.refreshUrl,return_url:e.payload.returnUrl}),{firebaseAdmin:s}=d();await s.firestore().collection(m).doc(e.authUser.uid).update({stripeConnectedAccountId:r.id});try{E({user:e.payload.userToCreateAccount,source:"stripe"})}catch(Ae){}let i={data:[{id:r.id,accountLink:a,createdConnectedAccount:r}]};return K.info(`END: ${f}`,{response:i}),i}import z from"firebase-functions/logger";var h="routes/deleteStripeAccount";async function I(e){var i;if(z.info(`START: ${h}`,{props:e}),o({props:e,requiredProps:["payload"]}),o({props:e.payload,requiredProps:["connectedAccountId"]}),!((i=e.authUser)!=null&&i.uid))throw new Error("props.authUser?.uid is undefined",{cause:{}});let{stripe:t}=n(),r=await t.accounts.del(e.payload.connectedAccountId),{firebaseAdmin:a}=d();await a.firestore().collection(m).doc(e.authUser.uid).update({stripeConnectedAccountId:!1});let s={data:[{id:r.id,stripeRes:r}]};return z.info(`END: ${h}`,{response:s}),s}import Y from"firebase-functions/logger";var A="routes/finishCreatingConnectedAccount";async function v(e){if(Y.info(`START: ${A}`,{props:e}),o({props:e,requiredProps:["payload"]}),o({props:e.payload,requiredProps:["userToCreateAccount"]}),!e.payload.userToCreateAccount.stripeConnectedAccountId)throw new Error(`${e.payload.userToCreateAccount.displayName} doesn't have a stripeConnectedAccountId`);let{stripe:t}=n(),r=await t.accountLinks.create({type:"account_onboarding",account:e.payload.userToCreateAccount.stripeConnectedAccountId,refresh_url:e.payload.refreshUrl,return_url:e.payload.returnUrl}),a={data:[{id:r.url,accountLink:r}]};return Y.info(`END: ${A}`,{response:a}),a}import X from"firebase-functions/logger";var y="routes/getConnectedAccount";async function D(e){X.info(`START: ${y}`,{props:e}),o({props:e,requiredProps:["payload"]}),o({props:e.payload,requiredProps:["connectedAccountId"]});let{stripe:t}=n(),r=await t.accounts.retrieve(e.payload.connectedAccountId),a={data:[{id:e.payload.connectedAccountId,connectedAccount:r}]};return X.info(`END: ${y}`,{response:a}),a}import J from"firebase-functions/logger";var S="routes/getStripeBalance";async function _(e){J.info(`START: ${S}`,{props:e}),o({props:e,requiredProps:["payload"]}),o({props:e.payload,requiredProps:["connectedAccountId"]});let{stripe:t}=n(),r=await t.balance.retrieve({stripeAccount:e.payload.connectedAccountId}),a={data:[{id:e.payload.connectedAccountId,balance:r}]};return J.info(`END: ${S}`,{response:a}),a}import Q from"firebase-functions/logger";var R="routes/getStripeConnectedAccountDashboardLink";async function q(e){Q.info(`START: ${R}`,{props:e}),o({props:e,requiredProps:["payload"]}),o({props:e.payload,requiredProps:["connectedAccountId"]});let{stripe:t}=n(),r=await t.accounts.createLoginLink(e.payload.connectedAccountId);if(!(r!=null&&r.url))throw new Error("dashboardLink?.url is undefined");let a={data:[{id:e.payload.connectedAccountId,dashboardLink:r}]};return Q.info(`END: ${R}`,{response:a}),a}async function U(e){if(o({props:e,requiredProps:["context"]}),e.context.route===l)try{return await x({authUser:e.authUser,payload:e.context.payload})}catch(t){throw new Error(`${l} - ${t}`,{cause:t==null?void 0:t.cause})}if(e.context.route===f)try{return await w({authUser:e.authUser,payload:e.context.payload})}catch(t){throw new Error(`${f} - ${t}`,{cause:t==null?void 0:t.cause})}if(e.context.route===h)try{return await I({authUser:e.authUser,payload:e.context.payload})}catch(t){throw new Error(`${h} - ${t}`,{cause:t==null?void 0:t.cause})}if(e.context.route===A)try{return await v({authUser:e.authUser,payload:e.context.payload})}catch(t){throw new Error(`${A} - ${t}`,{cause:t==null?void 0:t.cause})}if(e.context.route===y)try{return await D({authUser:e.authUser,payload:e.context.payload})}catch(t){throw new Error(`${y} - ${t}`,{cause:t==null?void 0:t.cause})}if(e.context.route===S)try{return await _({authUser:e.authUser,payload:e.context.payload})}catch(t){throw new Error(`${S} - ${t}`,{cause:t==null?void 0:t.cause})}if(e.context.route===R)try{return await q({authUser:e.authUser,payload:e.context.payload})}catch(t){throw new Error(`${R} - ${t}`,{cause:t==null?void 0:t.cause})}throw new Error(`Action doesn't exist - ${e.context.route}`,{cause:{props:e}})}async function N(e){if(e.context.route.startsWith("routes/"))return await U(e);throw new Error(`Route doesn't exist - ${e.context.route}`,{cause:{props:e}})}async function F(e){var t,r;try{return await N({authUser:e.request.auth,context:e.request.data})}catch(a){p({fnName:"miscFunctions",description:a,uid:(r=(t=e.request)==null?void 0:t.auth)==null?void 0:r.uid,throwHttpsError:!0,metadata:a==null?void 0:a.cause})}}import me from"firebase-functions/logger";async function k(e){var t;if(o({props:e,requiredProps:[]}),process.env.NODE_ENV==="development")return{stripeEvent:e.req.body};if(process.env.NODE_ENV==="production"&&!((t=e.req.body)!=null&&t.livemode))return me.info("Stopped early because this is sent from local development",{reqBody:e.req.body,NODE_ENV:process.env.NODE_ENV}),{stripeEvent:e.req.body,endEarly:!0};try{let r=process.env.STRIPE_SIGNING_SECERT_STRIPE_WEBHOOK_RECEIVER_PRODUCTION;if(!r)throw new Error("missing stripeWebhookSigningSecret");let a=e.req.headers["stripe-signature"];if(!a)throw new Error("missing sig (stripe-signature)");let{stripe:s}=n();return{stripeEvent:s.webhooks.constructEvent(e.req.rawBody,a,r)}}catch(r){throw new Error(`validateStripeWebhookRequest. ${r}`,{cause:{props:e}})}}import le from"firebase-functions/logger";async function $(e){let t=e.stripeEvent.data.object;return le.info("Received Stripe Webhook Event",{Stripe_Webhook_Event_Name:e.stripeEvent.type,stripeEventData:process.env.NODE_ENV==="development"?"":t,stripeEvent:e==null?void 0:e.stripeEvent,NODE_ENV:process.env.NODE_ENV}),e.stripeEvent.type,e.stripeEvent.type,{success:!0}}async function T(e){e.res.set("Access-Control-Allow-Origin","*");try{let t=await k({req:e.req});if(t.endEarly){e.res.status(200).json({data:void 0,error:void 0});return}let r=await $(t);e.res.status(200).json({data:r,error:void 0})}catch(t){p({fnName:"stripeWebhooksReceiver",description:t,metadata:t==null?void 0:t.cause}),e.res.status(500).json({error:t.toString()})}}import Z from"firebase-functions/logger";var P="routes/supbaseRouteExample";async function L(e){Z.info(`START: ${P}`,{props:e}),o({props:e,requiredProps:["payload"]}),o({props:e.payload,requiredProps:["name"]});let t={data:[{id:e.payload.name,success:!0}]};return Z.info(`END: ${P}`,{response:t}),t}async function G(e){if(o({props:e,requiredProps:["context"]}),e.context.route===P)try{return await L({authUser:e.authUser,payload:e.context.payload})}catch(t){throw new Error(`${P} - ${t}`,{cause:t==null?void 0:t.cause})}throw new Error(`Action doesn't exist - ${e.context.route}`)}async function W(e){if(e.context.route.startsWith("routes/"))return await G(e);throw new Error(`Route doesn't exist - ${e.context.route}`)}async function B(e){var t,r;try{return await W({authUser:e.request.auth,context:e.request.data})}catch(a){p({fnName:"supabaseDatabaseApi",description:a,uid:(r=(t=e.request)==null?void 0:t.auth)==null?void 0:r.uid,throwHttpsError:!0,metadata:a.cause})}}var zt=ee({memory:"1GiB"},async e=>await F({request:e})),Yt=he(async(e,t)=>await T({req:e,res:t})),Xt=ee(async e=>await B({request:e}));export{zt as miscFunctions,Yt as stripeWebhooksReceiver,Xt as supabaseDatabaseApi};
