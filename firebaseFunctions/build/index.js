import{onCall as te}from"firebase-functions/v2/https";function o(e){var n;let t=[],r={cause:{props:e,missingProps:t}};if(!e.props&&!e.condition)throw new Error("props are undefined",r);if(e.props){if(e.requiredProps&&((n=e.requiredProps)!=null&&n.length)&&e.requiredProps.forEach(i=>{var s;let c=String(i);if(((s=e.props)==null?void 0:s[c])===void 0)throw new Error(`Missing required prop: ${c}`,r)}),t.length)throw new Error(`Missing props: ${t.join(",")}`,r)}else if(!Boolean(e.condition))throw new Error("condition failed",r)}import N from"firebase-functions/logger";import{HttpsError as V}from"firebase-functions/v2/https";import{PostHog as j}from"posthog-node";var C={id:void 0,initContig:{api_host:"https://app.posthog.com",autocapture:!1,capture_pageleave:!1,capture_pageview:!1,disable_session_recording:!0}};async function p(e){var t;if(o({props:e,requiredProps:["eventName","data"]}),((t=process==null?void 0:process.env)==null?void 0:t.NODE_ENV)==="production"&&C.id){let r=new j(C.id);r.capture({distinctId:"nodePostHog",event:e.eventName,properties:{...e.data,metadata:e.data}}),await r.shutdownAsync()}}async function S(e){o({props:e,requiredProps:["description","fnName"]}),p({eventName:"Error",data:{description:String(e.description),functionName:e.fnName,uid:e.uid||"",metadata:e==null?void 0:e.metadata}})}function g(e){o({props:e,requiredProps:["description","fnName"]});let t={fnName:String(e.fnName),description:String(e.description),metadata:e.metadata,uid:e.uid};if(S(t),e.throwHttpsError)throw N.error(t.fnName+` - ${t.description}`,t),new V("failed-precondition",t.description);if(N.error(t.fnName+` - ${t.description}`,t),e.throwError)throw new Error(`${t.fnName} - ${t.description}`)}import k from"firebase-functions/logger";import q from"firebase-admin";q.initializeApp();function u(){return{firebaseAdmin:q}}var d="users";var l="routes/deactivateAccount";async function R(e){var i,c;if(k.info(`START: ${l}`,{props:e}),o({props:e,requiredProps:["payload"]}),o({props:e.payload,requiredProps:["uid"]}),((i=e.payload)==null?void 0:i.uid)!==((c=e.authUser)==null?void 0:c.uid))throw new Error("User Id does not match Auth User Id");let{firebaseAdmin:t}=u();await t.auth().deleteUser(e.authUser.uid);let r=await t.firestore().collection(d).where("id","==",e.authUser.uid).limit(1).get().then(s=>{if(s.empty)throw new Error("User Doc not found");return s.docs[0].data()});await t.firestore().collection(d).doc(r.id).delete();let n={data:[{id:r.id,success:!0}]};return k.info(`END: ${l}`,{response:n}),n}import L from"firebase-functions/logger";import z from"stripe";function a(){let e=process.env.NODE_ENV==="production"?process.env.STRIPE_SECRET_KEY_PRODUCTION:process.env.STRIPE_SECRET_KEY_DEVELOPMENT;if(!e)throw new Error("Unauthorized access to Stripe API");return{stripe:new z(e,{apiVersion:"2022-11-15"})}}var $=()=>process.env.NODE_ENV==="production",Y={siteInfo:{name:"Startup Template",title:"title",description:"description",domain:"https://www.domain.com",previewDomain:"https://www.previewDomain.com"},socialLinks:{discord:{link:"https://discord.gg/startup"},twitter:{link:"https://twitter.com/SocialSeedHQ"},mailto:{link:"mailto:info@socialseed.com"}},nextjs:{port:3001},firebase:{enabled:!0},devtools:{storybook:{port:6006},playwright:{testIdAttribute:"data-id"}},featureFlags:{email:{enabled:$()},credits:{developer:{enabled:!0}}},getIsPreviewEnv:()=>process.env.NEXT_PUBLIC_ENV==="preview",getIsProductionEnv:$},T=Y;function w(e){o({props:e,requiredProps:["source","user"]}),p({eventName:"seller_added_bank_account",data:{source:e.source,metadata:{...e}}})}var m="routes/createConnectedAccount";async function I(e){var s;if(L.info(`START: ${m}`,{props:e}),o({props:e,requiredProps:["payload"]}),o({props:e.payload,requiredProps:["refreshUrl","returnUrl","userToCreateAccount"]}),!((s=e.authUser)!=null&&s.uid))throw new Error("props.authUser?.uid is undefined",{cause:{}});let{stripe:t}=a(),r=await t.accounts.create({type:"express",business_type:"individual",business_profile:{url:`${T.siteInfo.domain}/user/${e.payload.userToCreateAccount.displayName}`},settings:{payouts:{schedule:{interval:"daily",delay_days:2}}}}),n=await t.accountLinks.create({type:"account_onboarding",account:r.id,refresh_url:e.payload.refreshUrl,return_url:e.payload.returnUrl}),{firebaseAdmin:i}=u();await i.firestore().collection(d).doc(e.authUser.uid).update({stripeConnectedAccountId:!1});try{w({user:e.payload.userToCreateAccount,source:"stripe"})}catch(re){}let c={data:[{id:r.id,accountLink:n,createdConnectedAccount:r}]};return L.info(`END: ${m}`,{response:c}),c}import G from"firebase-functions/logger";var f="routes/deleteStripeAccount";async function x(e){var c;if(G.info(`START: ${f}`,{props:e}),o({props:e,requiredProps:["payload"]}),o({props:e.payload,requiredProps:["connectedAccountId"]}),!((c=e.authUser)!=null&&c.uid))throw new Error("props.authUser?.uid is undefined",{cause:{}});let{stripe:t}=a(),r=await t.accounts.del(e.payload.connectedAccountId),{firebaseAdmin:n}=u();await n.firestore().collection(d).doc(e.authUser.uid).update({stripeConnectedAccountId:!1});let i={data:[{id:r.id,stripeRes:r}]};return G.info(`END: ${f}`,{response:i}),i}import B from"firebase-functions/logger";var A="routes/finishCreatingConnectedAccount";async function b(e){if(B.info(`START: ${A}`,{props:e}),o({props:e,requiredProps:["payload"]}),o({props:e.payload,requiredProps:["userToCreateAccount"]}),!e.payload.userToCreateAccount.stripeConnectedAccountId)throw new Error(`${e.payload.userToCreateAccount.displayName} doesn't have a stripeConnectedAccountId`);let{stripe:t}=a(),r=await t.accountLinks.create({type:"account_onboarding",account:e.payload.userToCreateAccount.stripeConnectedAccountId,refresh_url:e.payload.refreshUrl,return_url:e.payload.returnUrl}),n={data:[{id:r.url,accountLink:r}]};return B.info(`END: ${A}`,{response:n}),n}import H from"firebase-functions/logger";var h="routes/getConnectedAccount";async function E(e){H.info(`START: ${h}`,{props:e}),o({props:e,requiredProps:["payload"]}),o({props:e.payload,requiredProps:["connectedAccountId"]});let{stripe:t}=a(),r=await t.accounts.retrieve(e.payload.connectedAccountId),n={data:[{id:e.payload.connectedAccountId,connectedAccount:r}]};return H.info(`END: ${h}`,{response:n}),n}import M from"firebase-functions/logger";var y="routes/getStripeBalance";async function U(e){M.info(`START: ${y}`,{props:e}),o({props:e,requiredProps:["payload"]}),o({props:e.payload,requiredProps:["connectedAccountId"]});let{stripe:t}=a(),r=await t.balance.retrieve({stripeAccount:e.payload.connectedAccountId}),n={data:[{id:e.payload.connectedAccountId,balance:r}]};return M.info(`END: ${y}`,{response:n}),n}import O from"firebase-functions/logger";var P="routes/getStripeConnectedAccountDashboardLink";async function F(e){O.info(`START: ${P}`,{props:e}),o({props:e,requiredProps:["payload"]}),o({props:e.payload,requiredProps:["connectedAccountId"]});let{stripe:t}=a(),r=await t.accounts.createLoginLink(e.payload.connectedAccountId);if(!(r!=null&&r.url))throw new Error("dashboardLink?.url is undefined");let n={data:[{id:e.payload.connectedAccountId,dashboardLink:r}]};return O.info(`END: ${P}`,{response:n}),n}async function v(e){if(o({props:e,requiredProps:["context"]}),e.context.route===l)try{return await R({authUser:e.authUser,payload:e.context.payload})}catch(t){throw new Error(`${l} - ${t}`,{cause:t==null?void 0:t.cause})}if(e.context.route===m)try{return await I({authUser:e.authUser,payload:e.context.payload})}catch(t){throw new Error(`${m} - ${t}`,{cause:t==null?void 0:t.cause})}if(e.context.route===f)try{return await x({authUser:e.authUser,payload:e.context.payload})}catch(t){throw new Error(`${f} - ${t}`,{cause:t==null?void 0:t.cause})}if(e.context.route===A)try{return await b({authUser:e.authUser,payload:e.context.payload})}catch(t){throw new Error(`${A} - ${t}`,{cause:t==null?void 0:t.cause})}if(e.context.route===h)try{return await E({authUser:e.authUser,payload:e.context.payload})}catch(t){throw new Error(`${h} - ${t}`,{cause:t==null?void 0:t.cause})}if(e.context.route===y)try{return await U({authUser:e.authUser,payload:e.context.payload})}catch(t){throw new Error(`${y} - ${t}`,{cause:t==null?void 0:t.cause})}if(e.context.route===P)try{return await F({authUser:e.authUser,payload:e.context.payload})}catch(t){throw new Error(`${P} - ${t}`,{cause:t==null?void 0:t.cause})}throw new Error(`Action doesn't exist - ${e.context.route}`,{cause:{props:e}})}async function D(e){if(e.context.route.startsWith("routes/"))return await v(e);throw new Error(`Route doesn't exist - ${e.context.route}`,{cause:{props:e}})}async function _(e){var t,r;try{return await D({authUser:e.request.auth,context:e.request.data})}catch(n){g({fnName:"miscFunctions",description:n,uid:(r=(t=e.request)==null?void 0:t.auth)==null?void 0:r.uid,throwHttpsError:!0,metadata:n==null?void 0:n.cause})}}var ut=te({memory:"1GiB"},async e=>await _({request:e}));export{ut as miscFunctions};
